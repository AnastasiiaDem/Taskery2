<div style="margin: 3rem auto 1rem; text-align: center;">
  <span class="tooltiptext">Add new task</span>
  <button (click)="addTask(addUpdateContent)" mat-mini-fab aria-label="Create new task" class="add-btn" id="mat-btn">
    <mat-icon style="color: #666666 !important;">add</mat-icon>
  </button>
</div>


<div class="w3-animate-opacity" style="margin: 0 auto; width: 95%;">
  <div style="display: flex; align-items: flex-end; margin-bottom: 10px;">
    <div ngbDropdown class="d-inline-block" placement="right-top" [autoClose]="'outside'"
         style="height: 23px !important;">
      <button (click)="filterMenu()" id="dropdown" ngbDropdownToggle class="filter-btn">
        <mat-icon style="font-size: 20px; height: auto !important;">filter_list</mat-icon>
      </button>
      <div ngbDropdownMenu aria-labelledby="dropdown" id="ngbDropdownMenu" style="transform: translate(50px, 0px)">
        <div class="px-4 py-3">
          <div class="form-group form-floating mb-3 select-container">
            <input class="form-control" type="text" placeholder="Search Task" style="height: 40px;"
                   [(ngModel)]="searchText" (keyup)="filter($event, 'search')">
            <label>Search Task</label>
          </div>
          <hr style="color: rgb(136 136 136);">
          <div class="form-group form-floating mb-3 select-container">
            <ng-select2 [placeholder]="'Employee Filter'" [allowClear]="true" [(ngModel)]="selectedUser"
                        [width]="'100%'"
                        [data]="usersData" (valueChanged)="filter($event, 'employee')">
            </ng-select2>
          </div>
          <hr style="color: rgb(136 136 136);">
          <div class="form-group form-floating mb-1 select-container" style="width: 100%;">
            <ng-select2 [placeholder]="'Date Filter'" [allowClear]="true" [(ngModel)]="dateFilterValue" [width]="'100%'"
                        [data]="dateFilterData" (valueChanged)="dateFilter($event)">
            </ng-select2>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div class="form-floating" [ngStyle]="{width: dateFilterValue == 'between' ? '49%' : '100%'}"
                 *ngIf="dateFilterValue == 'after' || dateFilterValue == 'between'">
              <input [disabled]="isFrom" class="form-control" type="date" [(ngModel)]="date1Value"
                     style="height: 40px; font-size: 12px;" id="date1" (change)="filter(null, 'date')">
              <label>from</label>
            </div>
            <div class="form-floating" [ngStyle]="{width: dateFilterValue == 'between' ? '49%' : '100%'}"
                 *ngIf="dateFilterValue == 'before' || dateFilterValue == 'equal' || dateFilterValue == 'between'">
              <input [disabled]="isTo" class="form-control" type="date" [(ngModel)]="date2Value"
                     style="height: 40px; font-size: 12px;" id="date2" (change)="filter(null, 'date')">
              <label>to</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <button *ngIf="currentUser.role != 'ProjectManager'" [ngClass]="onlyMyIssues ? 'my-tasks' : 'all-tasks'"
            style="font-size: 11px; height: 22px;" (click)="findMyIssues()">
      Only My Issues
    </button>
  </div>
  
  
  <ejs-kanban #kanban keyField='status'
              [dataSource]='tasks'
              [cardSettings]='cardSettings'
              (cardDoubleClick)='openModal(previewContent, $event)'
              (dragStop)="drop($event)">
    <e-columns>
      <e-column headerText='To Do' keyField='To Do'></e-column>
      <e-column headerText='In Progress' keyField='In Progress'></e-column>
      <e-column headerText='On Review' keyField='On Review'></e-column>
      <e-column headerText='Done' keyField='Done'></e-column>
    </e-columns>
    <ng-template #cardSettingsTemplate let-data>
      <div class='e-card-content'>
        <table class="card-template-wrap">
          <tbody>
          <tr>
            <td class="CardHeader">
              <p>{{data.title}}</p>
              <p class="card-deadline" [ngStyle]="overdueDateStyle(data)">{{data.deadline | date}}</p>
            </td>
          </tr>
          <tr>
<!--            <td class="CardBody">{{data.description}}</td>-->
            <td class="CardBody" [innerHTML]="data.description | safeHtml"></td>
          </tr>
          </tbody>
        </table>
      </div>
    </ng-template>
  </ejs-kanban>
</div>


<ng-template #addUpdateContent let-modal>
  <div class="container">
    <div class="row align-items-center">
      <div class="card-header px-lg-5">
        <div class="card-heading text-primary">{{addTaskFlag ? 'Add new task' : 'Update the task'}}
          <!--          <img *ngIf="!addTaskFlag"-->
          <!--               src="https://img.icons8.com/ios-glyphs/30/444444/delete.png" alt=""-->
          <!--               class="trash"-->
          <!--               (click)="deleteTask(modal)">-->
        </div>
      </div>
      <div class="card-body" style="padding: 2rem!important;">
        <form [formGroup]="taskForm" (ngSubmit)="onSubmit(modal)">
          <div style="display: flex;">
            <div class="form-floating right-field" style="width: 100%; margin-left: 0 !important;">
              <input class="form-control" type="text" placeholder="Title" formControlName="title"
                     [ngClass]="{ 'is-invalid': submitted && taskForm.invalid && f.title.errors }" required>
              <label>Title</label>
            </div>
          </div>
          <div class="form-floating mb-3">
<!--            <textarea class="form-control" style="padding-top: 0.5rem; height: 150px;" formControlName="description"-->
<!--                      placeholder="Description"></textarea>-->
            <quill-editor class="form-control" style="padding: 1rem .75rem; height: 150px;"
                          formControlName="description" placeholder="Description"
                          [modules]="quillConfig"></quill-editor>
          </div>
          <div class="form-floating mb-3">
            <ng-select2 formControlName="employeeId" [width]="'100%'" [data]="employeeData">
            </ng-select2>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 1rem;">
            <div class="form-floating mb-3" style="width: 30%;">
              <input class="form-control" type="date" placeholder="Deadline date" formControlName="deadline"
                     [ngClass]="{ 'is-invalid': submitted && taskForm.invalid && f.deadline.errors }" required>
              <label>Deadline date</label>
            </div>
            <div class="form-floating right-field" style="width: 70%;">
              <ng-select2 formControlName="status" [width]="'100%'" [data]="statusData">
              </ng-select2>
            </div>
          </div>
          <button class="btn btn-primary close-button" type="submit"
                  style="border-radius: 0 0 calc(1rem - 1px) calc(1rem - 1px)"
                  [disabled]="taskForm.invalid">submit
          </button>
        </form>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #previewContent let-modal>
  <div class="container">
    <div class="row align-items-center">
      <div class="card-body" style="padding: 2rem;">
        <div class="form-floating title-block">
          {{previewData.title}}
        </div>
        <hr class="line">
        <div class="body-content">
        <div class="left-block">
          <div class="form-floating">
            <p>STATUS</p>
            <span>{{previewData.status}}</span>
          </div>
          <div class="form-floating">
            <p>DEADLINE</p>
            <span>{{previewData.deadline}}</span>
          </div>
          <div class="form-floating">
            <p>ASSIGNEE</p>
            <span>{{previewData.employee}}</span>
          </div>
        </div>
        <div class="right-block">
          <div class="form-floating description-block" [innerHTML]="previewData.description | safeHtml">
          </div>
        </div>
        </div>
      </div>
      <div class="card-footer">
        <div class="action-btns">
          <button class="update-task" (click)="updateTask(addUpdateContent, modal)">
            Update
          </button>
          <button class="delete-task" (click)="deleteTask(deleteContent, modal)">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #deleteContent let-modal>
  <div class="container">
    <div class="row align-items-center">
      <div class="card-body" style="padding: 3rem!important;">
        <h5 style="text-align: center;">Are you sure you want to delete this task?</h5>
        <div style="display: flex; justify-content: space-around; align-items: center; margin-top: 50px;">
          <button style="font-size: 13px;" class="btn btn-outline-danger" (click)="isDelete('cancel', modal)">Cancel
          </button>
          <button style="font-size: 13px;" class="btn btn-outline-primary" (click)="isDelete('confirm', modal)">
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ngx-spinner bdColor="rgb(170 170 170 / 50%)" size="default" color="rgb(32 32 32)" type="ball-atom"></ngx-spinner>
